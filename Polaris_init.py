# Communication via serial port with Polaris Spectra Camera
# Ensure that read write permissions are available: sudo chmod 777 /dev/ttyS0
# sys.path.append("~/p3/lib/python3.5/site-packages")

import sys
import serial as ps
import numpy as np
import time
from matplotlib import pyplot as plt

### Initialize Polaris, collect data and display marker position ###

ser = ps.Serial(port='/dev/ttyS0',baudrate=9600,bytesize=ps.EIGHTBITS,parity=ps.PARITY_NONE,stopbits = ps.STOPBITS_ONE,timeout=1,rtscts=True) #exclusive=True)
if ser.isOpen():
    print('Device communication opened on ' + ser.name)

time.sleep(2)

ser.send_break()
time.sleep(1)

ser.write(b'RESET 0\r')
time.sleep(5)
x = ser.read_until('\r')
print(x)
#time.sleep(1)

ser.write(b'BEEP 1\r')
#time.sleep(2)
x = ser.read_until('\r')
print(x)
#time.sleep(2)

### Initialze ###
ser.write(b'INIT \r')
#time.sleep(2)
x = ser.read_until('\r')
print(x)

ser.write(b'PHRQ *********1****\r')
#time.sleep(2)
x = ser.read_until('\r')
print(x)

### Load Tool File ###
ser.write(b'PVWR 0100004E4449009D080000010000000100000201000000018C9932B400000003000000030000000000C03F000000000000000000000000000000000000000000000000\r')
ser.write(b'PVWR 010040000020410000000000000000000000000000000000000000000000000000484200000000000000000000D2420000000000000000000000000000000000000000\r')
ser.write(b'PVWR 01008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r')
ser.write(b'PVWR 0100C000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r')
ser.write(b'PVWR 01010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r')
ser.write(b'PVWR 01014000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r')
ser.write(b'PVWR 01018000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r')
ser.write(b'PVWR 0101C000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r')
ser.write(b'PVWR 0102000000000000000000000000000000000000000000000000000000000000000000000000000000000000010200000000000000000000000000000000001F1F1F1F\r')
ser.write(b'PVWR 010240090000004E4449000000000000000000383730303234380000000000000000000000000009010101000000000000000000000000000000000001010100000000\r')
ser.write(b'PVWR 01028000000000000000000000000000800029000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r')
ser.write(b'PVWR 0102C000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r')
#time.sleep(2)
x = ser.read_until('\r')
print(x)


### Set Port ###
ser.write(b'PINIT 01\r')
#time.sleep(2)
x = ser.read_until('\r')
print(x)


ser.write(b'PENA 01S\r')
#time.sleep(2)
x = ser.read_until('\r')
print(x)

ser.write(b'IRATE 2\r')
#time.sleep(2)
x = ser.read_until('\r')
print(x)

ser.write(b'VSEL 1\r')
#time.sleep(2)
x = ser.read(100)
print(x)

ser.write(b'TSTART \r')
#time.sleep(2)
x = ser.read_until('\r')
print(x)

ser.write(b'COMM 50001\r')
x = ser.read_until('\r')
print(x)

ser.close()
